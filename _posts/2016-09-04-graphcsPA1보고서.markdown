---

제목: Simple Graphic Editor 

글쓴이: 200721395 한경수(hsnks100@gmail.com)

날짜: 2016-09-20

--- 

## 개요

간단한 html5 canvas 를 이용하여 graphic editor 를 만들어보는 과제다..

![](../images/graphic_pa01/1.jpg)

전체적인 구조는 그래픽 요소를 json object 로 가지고 있으면서 requestAnimationFrame 을 통해 canvas 에 그리는 방식으로 동작한다.

``` javascript
function redraw(){ 
    //Clear screen
    context.clearRect(0, 0, canvasWidth, canvasHeight); 
    // #1 draw part
}

```

위와 같이 그리기가 필요할 때 redraw(); 가 canvas 를 그린다.  #1 부분에서 저장된 객체가 loop 를 돌면서 draw 를 하는 구조로 갈 것이다.

## 기본구현

### layout 잡기

``` html
<div class="container">
  <div class="toolbox">
    <button onclick="drawMode = drawModes.line;" class="tool">선분</button>
    <button onclick="drawMode = drawModes.circle;" class="tool">원</button>
    <button onclick="drawMode = drawModes.rect;" class="tool">사각형</button>
    <button onclick="selectPolygon();" class="tool">다각형</button>
    <button onclick="drawMode = drawModes.bezier;" class="tool">곡선</button>

    <hr />
    <button click="" class="tool">색채우기</button>
    <div id="currentFill" class="current-fill"></div>

    <div class="fill-palette fill-black" style="float:left;"></div>
    <div class="fill-palette fill-red" style="float:left;"></div>
    <div class="fill-palette fill-green" style="float:left;"></div>
    <div class="fill-palette fill-blue"></div>
    <div class="fill-palette fill-wine" style="float:left;"></div>
    <div class="fill-palette fill-violet" style="float:left;"></div>
    <div style="clear:left;"></div> 
    <input type="file" onchange="readURL(event);"/>
    <hr />
    <div id="currentStroke" class="current-stroke"></div>

    <div class="stroke-palette stroke-black" style="float:left;"></div>
    <div class="stroke-palette stroke-red" style="float:left;"></div>
    <div class="stroke-palette stroke-green" style="float:left;"></div>
    <div class="stroke-palette stroke-blue"></div>
    <div class="stroke-palette stroke-wine" style="float:left;"></div>
    <div class="stroke-palette stroke-violet" style="float:left;"></div>
    <div style="clear:left;"></div>

    <button click="" class="tool">선색</button>

    <img src="line_width1.jpg" onclick='lineWidth = 1;'/>
    <img src="line_width3.jpg" onclick='lineWidth = 3;'/>
    <img src="line_width5.jpg" onclick='lineWidth = 5;'/>
    <img src="line_width7.jpg" onclick='lineWidth = 7;'/>
  </div>
  <div>
    <canvas id="myCanvas" class="canvas" width="600" height="200"></canvas>
  </div>

  <div class="menu"> 
    <button id="load" onclick='loadf();'>불러오기</button>
    <button id="save" onclick='savef();'>저장하기</button>

    <input id="loadbtn" type="file" name="loadbtn" style="display: none;" />
  </div> 
</div>
```

위와 같이 div 를 잡으면 

<pre>
|----|------------------|
|----|------------------|
|----|------------------|
|----|------------------|
|tool|       canvas     |
|----|------------------|
|----|------------------|
|----|------------------|
|----|------------------|
|----|  load,   save    |
</pre>

구조로 잡힌다.

### canvas 선언부

``` javascript
canvas = document.getElementById('myCanvas');
context = canvas.getContext('2d');

canvasWidth = canvas.width;
canvasHeight = canvas.height;

```

교재에 나온대로 평범하게 canvas 를 잡는다. 

### canvas mousedown / mouseup

``` javascript
canvas.onmousedown = function(e){
console.log(e);
downPos = {x:e.offsetX, y:e.offsetY}; // e.client 
};
```

mousedown 부는 별거 없다. 그냥 처음에 찍은 좌표를 알아야 직선이든 원이든 사각형이든 정보를 넣을 수 있으므로 클릭 좌표를 저장해놓는다..


``` javascript
    canvas.onmouseup = function(e){
        context.strokeStyle = strokeColor;
        context.lineWidth = lineWidth;
        if(fillMode === FILLMODE.pattern){
            var pattern = context.createPattern(patternObj, 'repeat');
            context.fillStyle = pattern;
        }
        else{
            context.fillStyle = fillColor;
        }

        var patternSrc = "";
        if(fillMode){
            patternSrc = patternObj.src;
        }

        if(drawMode == drawModes.line){
            drawObjects.push({"type":"line", "strokeColor":strokeColor, "fillColor":fillColor, "lineWidth":lineWidth,
                "x":downPos.x, "y":downPos.y, "dx":e.offsetX, "dy":e.offsetY});
        }
        else if(drawMode == drawModes.circle){

            drawObjects.push({"type":"circle", "strokeColor":strokeColor, "fillColor":fillColor, "lineWidth":lineWidth,
                "fillMode":fillMode, "patternSrc":patternSrc,
                "x":downPos.x, "y":downPos.y, "r":Math.dist(e.offsetX - downPos.x, e.offsetY - downPos.y)});
            //context.fill(downPos.x, downPos.y, e.offsetX - downPos.x, e.offsetY - downPos.y); 
        }
        ...
        redraw();
    }

```

mouseup 부는 마우스를 뗏을 때 drawObjects 로 객체를 차곡차곡 push 하는 역할을 한다. 들어가는 정보는 type, strokeColor, fillColor, lineWidth, pattern, etc..


### 여러가지 도형을 그려본 모습

![](../images/graphic_pa01/2.jpg)

## 추가구현
### 그려진 모든 객체를 표현하는 방법

>그려진 객체 하나를 표현하는 방법은 각 도형별로 type, strokeColor, fillColor,
  lineWidth, fillMode, patternSrc, 기타 도형만의 특성

으로 표현하면 과제상으로 나온 스펙을 표현하기에 부족함이 없다. 예를 들어 circle 인 경우를 표현하면 다음과 같다.

``` json
{
  "type": "circle",
  "strokeColor": "rgb(255, 0, 0)",
  "fillColor": "rgb(0, 0, 0)",
  "lineWidth": 3,
  "fillMode": 0,
  "patternSrc": "",
  "x": 105,
  "y": 26,
  "r": 56.00892785976178
}

```

이러한 객체를 array 로 담으면 모든 객체가 표현가능하게 된다.


### 그려진 객체를 저장하는 방법

파일을 저장하는 방법은 브라우저별로 매우 종속적인 구현이 필요하여 이미 구현된 library 를 이용하기로 했다.


``` javascript
/* FileSaver.js
 *  A saveAs() & saveTextAs() FileSaver implementation.
 *  2014-06-24
 *
 *  Modify by Brian Chen
 *  Author: Eli Grey, http://eligrey.com
 *  License: X11/MIT
 *    See https://github.com/eligrey/FileSaver.js/blob/master/LICENSE.md
 */
```

[FileSaver.js](https://github.com/eligrey/FileSaver.js/) 라는 library 인데 MIT license 를 따르고 있고, 파일 저장하기에 많은 브라우저를 지원하고 있는 library 다.


``` html
function savef(){
    var g = JSON.stringify(drawObjects);
    saveTextAs(g, "save.dat");
    drawObjects = JSON.parse($("#ta").val());
}
<button id="save" onclick='savef();'>저장하기</button>
```

일단 위에 나열된 방법으로 저장된 json object 인 drawObjects 를 JSON.stringify 로 문자열로 얻어내고 그것을 저장하는 방법을 생각해야한다.
g 에 drawObjects 문자열을 저장한 후 saveTextAs 로 저장을 하면 파일이 생성되어 브라우저에서 다운로드가 가능하다.

``` json
[
  {
    "type": "circle",
    "strokeColor": "rgb(255, 0, 0)",
    "fillColor": "rgb(0, 0, 0)",
    "lineWidth": 3,
    "fillMode": 0,
    "patternSrc": "",
    "x": 105,
    "y": 26,
    "r": 56.00892785976178
  },
  {
    "type": "rect",
    "strokeColor": "rgb(255, 0, 0)",
    "fillColor": "rgb(0, 0, 0)",
    "lineWidth": 3,
    "fillMode": 0,
    "patternSrc": "",
    "x": 198,
    "y": 123,
    "w": 128,
    "h": -56
  },
  [{"type":"rect","strokeColor":"rgb(255, 0, 0)","fillColor":"rgb(0, 0, 0)","lineWidth":3,"fillMode":1,"patternSrc":"data:image/png;base64,iVBORw0KGg...",
  "x":171,"y":93,"w":73,"h":35}]
  ...
]

```

샘플로 그려본 객체의 일부 json 이다. 여기서 pattern 은 image:base64 형태로 저장되어 원본의 url 이 필요가 없다.


### 불러오기를 통해 불러오는 방법
``` html

<button id="load" onclick="$('#loadbtn').trigger('click');">불러오기</button>
<input id="loadbtn" type="file" name="loadbtn" style="display: none;"
onchange="loadf(event);" />
function loadf(event){
    selectedFile = event.target.files[0];
    var reader = new FileReader(); 
    reader.onload = function(event) {
        drawObjects = JSON.parse(event.target.result);
    };
    reader.readAsText(selectedFile); 
}
```

불러오기를 통해 로컬데이터를 가져오는 방법은 상대적으로 간단한데, 
그림파일 로드하는것과 마찬가지로 하는데 reader.readAsDataURL 대신에 
reader.readAsText 를 통해, Text 를 얻어와서 drawObjects 에 JSON.parse 한 결과를 넣어주면 바로 로드가 된다.



## 결과

이 프로젝트의 핵심은 객체를 어떤식으로 저장할것인가 설계하는게 중요했고, 그 저장된 객체를 어떤식으로 렌더링 할것인지 정하고 구현하는 것이었다.
이 과정만 되면 저장하기와 불러오기는 그냥 JSON parse 의 문제로 간단하게 해결되었다.

개인적으로 추가구현으로 했으면 하는 부분은 다음과 같다.

* undo/redo
* gradient fill
* layers 이미지 설계
* fill bucket (영역 채우기)

## 마치며

앞으로 webgl 프로젝트가 canvas 에서 이뤄지기 때문에, 미리 canvas 에 익숙해지는 계기가 되었고, canvas 의 flat 특성을 이해할 수 있었다. 
opengl 도 여러 객체를 그리는 방법은 크게 다르지 않을거라 생각한다. 에니메이션을 하기 위해 매 프레임마다 clear 를 하게 되고, draw 를 하게 되는 과정으로 그림을 그리게 될것이라고 예상할 수 있다. 






